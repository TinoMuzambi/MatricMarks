---
title: "Matric Marks"
author: "Tino Muzambi"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(tidyverse)
library(sf)
library(rnaturalearth)
library(tmap)
```


# Read data
```{r}
bachelor.pass <- read.csv("./data/South_Africa_Bachelor_passes_by_province.csv") %>% as_tibble()
maths <- read.csv("./data/South_Africa_Bachelor_passes_by_province.csv") %>% as_tibble()
physics <- read.csv("./data/South_Africa_National_Senior_Certificate_Physical_Science_results_v2.csv") %>% as_tibble()
```

# Look at data
```{r}
summary(bachelor.pass)

summary(maths)

summary(physics)
```

# Clean up data
```{r}
# Lookup table for converting shorthand to full name.
province.names <- c("zaf" = "South Africa", "ec" = "Eastern Cape", "fs" = "Free State", "gp" = "Gauteng",
                    "kzn" = "KwaZulu-Natal", "lp" = "Limpopo", "mp" = "Mpumalanga", "nw" = "North West",
                    "nc" = "Northern Cape", "wc" = "Western Cape")

# Drop date & percent.
bachelor.pass <- bachelor.pass %>% 
  select(-date, -contains("percent"))

maths <- maths %>% 
  select(-date, -contains("percent"))

physics <- physics %>% 
  select(-date)
```

# Pivot Longer
```{r}
bachelor.pass.long <- bachelor.pass %>%
pivot_longer(
    cols = c(starts_with("zaf"), starts_with("ec"), starts_with("fs"),
             starts_with("gp"), starts_with("kzn"), starts_with("lp"),
             starts_with("mp"), starts_with("nw"), starts_with("nc"),
             starts_with("wc")),
    names_to = c("province", "ignore1", "data1", "data2","ignore2", "ignore3", "ignore4"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  select(matric_class, province, data1, data2, value) %>% 
  mutate(type = case_when(
    grepl("passed", data1) | grepl("passed", data2) ~ "passed",
    grepl("wrote", data1) | grepl("wrote", data2) ~ "wrote"
  )) %>% 
  select(-c("data1", "data2")) %>%
  pivot_wider(names_from = type, values_from = value) %>%
  rename(num.wrote = `wrote`, num.passed = `passed`)%>% 
  mutate(province = province.names[province]) # Replace provinces with full name.
```

# Pivot Maths Longer
```{r}
maths.long <- maths %>%
pivot_longer(
    cols = c(starts_with("zaf"), starts_with("ec"), starts_with("fs"),
             starts_with("gp"), starts_with("kzn"), starts_with("lp"),
             starts_with("mp"), starts_with("nw"), starts_with("nc"),
             starts_with("wc")),
    names_to = c("province", "ignore1", "data1", "data2","ignore2", "ignore3", "ignore4"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  select(matric_class, province, data1, data2, value) %>% 
  mutate(type = case_when(
    grepl("passed", data1) | grepl("passed", data2) ~ "passed",
    grepl("wrote", data1) | grepl("wrote", data2) ~ "wrote"
  )) %>% 
  select(-c("data1", "data2")) %>%
  pivot_wider(names_from = type, values_from = value) %>%
  rename(num.wrote = `wrote`, num.passed = `passed`)%>% 
  mutate(province = province.names[province]) # Replace provinces with full name.
```

Pivot Physics Longer
```{r}
percent.values <- c("30percent", "40percent", "50percent")

physics.long <- physics %>%
pivot_longer(
    cols = c(starts_with("zaf"), starts_with("ec"), starts_with("fs"),
             starts_with("gp"), starts_with("kzn"), starts_with("lp"),
             starts_with("mp"), starts_with("nw"), starts_with("nc"),
             starts_with("wc")),
    names_to = c("province", "ignore1", "ignore2", "ignore3","ingore4", "pass.rate"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  select(matric_class, province, pass.rate, value) %>% 
  mutate(province = province.names[province], pass.rate = as.numeric(str_extract(pass.rate, "\\d+"))) %>% # Replace provinces with full name.
  pivot_wider(names_from = pass.rate, values_from = value) %>%
  rename(thirty = `30`, fourty = `40`, fifty = `50`)
```


# Line Chart: Trend of Learners who Wrote Matric Exams and Passed with Bachelor Pass
```{r}
all.provinces.plot <- bachelor.pass.long %>% 
  ggplot(aes(x = matric_class)) +
  geom_line(aes(y = num.wrote, group = province)) +
  geom_line(aes(y = num.passed, group = province), linetype = "dashed") +
  facet_wrap(~province, scales = "free_y") +
  labs(x = "Matric Class", y = "Number of Learners", color = "Type") +
  theme_minimal()
all.provinces.plot
```
# Stacked Bar Chart: Proportion of Learners who Passed with Bachelor Pass

```{r}
bachelor.pass.long %>%
  mutate(proportion = ifelse(type == "passed", value / sum(value), value / sum(value))) %>%
  ggplot(aes(x = matric_class, y = proportion, fill = type)) +
  geom_col(position = "fill") +
  facet_grid(rows = vars(province)) +
  labs(x = "Matric Class", y = "Proportion", fill = "Type") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()
```
# Choropleth Map: Learners who Passed with Bachelor Pass in the Latest Year
```{r}
# Load South Africa province boundaries
sa.provinces <- ne_states(country = "South Africa", returnclass = "sf")

# Filter data for the latest year and join with province boundaries
latest.year <- max(bachelor.pass.long$matric_class)
bachelor.latest <- bachelor.pass.long %>%
  filter(matric_class == latest.year, type == "passed")

map.data <- left_join(sa.provinces, bachelor.latest, by = c("name" = "province"))

# Create the choropleth map
marks.map <- tm_shape(map.data) +
  tm_fill("value", style = "quantile", title = "Learners Passed\nwith Bachelor Pass") +
  tm_text("name", size = 0.8) +
  tm_layout(frame = F,
            legend.outside = T,
            legend.position = c("right", "center"))
marks.map
```

```{r}
ggplot(bachelor.pass.long, aes(x = num.wrote, y = num.passed, color = province)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Learners who Wrote Matric Exams", y = "Learners Passed with Bachelor Pass", color = "Province") +
  theme_minimal()
```

